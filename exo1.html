<!DOCTYPE html>
<html>
 <head>
   <meta charset="utf-8">
   <title>Monuments Historiques de France</title>
   <link rel="icon" href="data:,">
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
   <link rel="stylesheet" type="text/css" href="projet.css">
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
   <style>
    #map { width: 600px; height: 600px; }
  </style>
 </head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class = "title_details">
      <span class = "title_name"> Monuments Historiques</span>
    </div>    
      <!-- Dropdown Filter -->
      <div id="region-select-container" >
        <label for="region_select">Région</label>
        <select name="region" id="region_select">
          <option value="">--Région--</option>
        </select>
      <div id="depart-select-container" >
        <label for="depart_select">Département</label>
        <select name="depart" id="depart_select">
          <option value="">--Département--</option>
        </select>
      </div>
      
  <!-- Map -->
  <div id="map"></div>
  <script>
    "use strict";
    function add_options_department(data){
        let departments_dict = {};
        let regions_dict = {};
        let departments_regions = {}
        let i;
        for( i = 0; i< data.features.length; i++){
            let departement = (((data.features)[i]).properties['departement_en_lettres'])[0];
            console.log("dept", departement);
            let region      = (((data.features)[i]).properties['region'])[0];
            console.log("region", region);
            if (departement in departments_dict){
              departments_dict[departement]++;
            }
            else{
              departments_dict[departement] = 1;

            }
            if (region in regions_dict){
              regions_dict[region] ++;
            }
            else{
              regions_dict[region] = 1;

            }
            if ((region in departments_regions)){
              if(!((departments_regions[region]).includes(departement))){
                departments_regions[region].push(departement);
              }
            }else {
              departments_regions[region] = [departement];
            }
          }
        let select_region = document.getElementById('region_select');
        let select_dept= document.getElementById('depart_select');
        const options_dep = Object.keys(departments_dict);
        const options_reg =  Object.keys(regions_dict);
        console.log(options_dep);
        console.log(options_reg);
        options_reg.forEach(optionValue => {
          const option = document.createElement('option');
          option.value = optionValue; 
          option.textContent = optionValue +' ' + regions_dict[optionValue];
          select_region.appendChild(option); 
          console.log(select_region);
      });
        options_dep.forEach(optionValue => {
          const option= document.createElement('option');
          option.value = optionValue; 
          option.textContent = optionValue +' ' + departments_dict[optionValue];
          select_dept.appendChild(option); 
      });
    }    
    function createGeolayer( map, data, value){
      return L.geoJSON(data, {
        filter: function (feature){
          return feature.properties['departement_en_lettres'][0] === value;
        },
        onEachFeature: function (feature, layer) {
              console.log("value", value);
              if (!(((feature.properties['departement_en_lettres'])[0]) === value)) {
                  return null; // Exclude any undefined or invalid features
              }
              layer.bindPopup(feature.properties['titre_editorial_de_la_notice']);
        },
      }).addTo(map);
    }
    function modify_layer(map, geoLayer, data, value ){
      map.removeLayer(geoLayer);
      return createGeolayer(map, data, value);
    
    }
    function get_user_select(map, geoLayer, id, data ){
      let user_selection = document.getElementById(id);
      user_selection.addEventListener('change', function(event){
        let element_selected = event.target.value;
        console.log("yoo", element_selected);
        geoLayer = modify_layer(map, geoLayer, data, element_selected)
      });
    }
    window.onload = async () => {
        let map = L.map('map',{
          center: [48.665343,2.842226],
          zoom: 9
      });
        var layer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{
              maxZoom: 15,
              attribution: '© <a href="http://www.openstreetmap.org/copyright">OSM</a>'
        });
        layer.addTo(map);
        let response = await fetch("./monuments_historiques.geojson");
        let data = await response.json();
        let geoLayer = L.geoJSON(data);
        const depart_select_id = 'depart_select';
        add_options_department(data);
        get_user_select(map, geoLayer, depart_select_id, data);
    };
  </script>
 </body>
</html>

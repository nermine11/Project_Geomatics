<!DOCTYPE html>
<html>
 <head>
   <meta charset="utf-8">
   <title>Monuments Historiques de France</title>
   <link rel="icon" href="data:,">
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
   <link rel="stylesheet" type="text/css" href="projet.css">
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
   <style>
    #map { width: 600px; height: 600px; }
  </style>
 </head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class = "title_details">
      <span class = "title_name"> Monuments Historiques</span>
    </div>    
      <!-- Dropdown Filter -->
      <div id="region-select-container"  >
        <label for="region_select">Région</label>
        <select name="region" id="region_select" >
          <option value="">--Région--</option>
        </select>
      <div id="depart-select-container" >
        <label for="depart_select">Département</label>
        <select name="depart" id="depart_select">
          <option value="">--Département--</option>
        </select>
      </div>
      
  <!-- Map -->
  <div id="map"></div>
  <script>
    "use strict";
    let departments_regions = {}; 
    function add_options_depart_region(data){
        let departments_dict = {};
        let regions_dict = {};
        let i;
        for( i = 0; i< data.features.length; i++){
          let departement = (((data.features)[i]).properties['departement_en_lettres'])[0];
          let region      = (((data.features)[i]).properties['region'])[0];
          if (departement in departments_dict){
            departments_dict[departement]++;
          }
          else{
            departments_dict[departement] = 1;
          }
          if (region in regions_dict){
            regions_dict[region] ++;
          }
          else{
            regions_dict[region] = 1;
          }
          if ((region in departments_regions)){
            if(!((departments_regions[region]).includes(departement))){
              departments_regions[region].push(departement);
            }
          }else {
            departments_regions[region] = [departement];
          }
        }
        add_options(regions_dict, 'region_select');
        add_options(departments_dict, 'depart_select');

    }    
    function add_options(options, id){
      let select_elt= document.getElementById(id);
      const options_elt = Object.keys(options);
      options_elt.forEach(optionValue => {
          const option= document.createElement('option');
          option.value = optionValue; 
          option.textContent = optionValue +' ' + options[optionValue];
          select_elt.appendChild(option); 
      });
    }
    function clear_depart_dropdown(id) {
      let select_elt = document.getElementById(id);
      while(select_elt.options.length > 1) {
        select_elt.remove(1); 
      }
    }
    //based on the region
    function modify_depart_dropdown(map, data, region){ 
      let depart_id = 'depart_select';
      clear_depart_dropdown(depart_id);
      let departments = departments_regions[region];
      add_options(departments, depart_id);
    }
    function createGeolayer( map, data, value, id, property){
      if(id == 'region_select'){
        modify_depart_dropdown(map, data, value);
      }
      return L.geoJSON(data, {
        filter: function (feature){
          return feature.properties[property][0] === value;
        },
        onEachFeature: function (feature, layer) {
              if (!(((feature.properties[property])[0]) === value)) {
                  return null; // Exclude any undefined or invalid features
              }
              layer.bindPopup(feature.properties['titre_editorial_de_la_notice']);
        },
      }).addTo(map);
    }
    function modify_layer(map, geoLayer, data, value , id){
      let property;
      map.removeLayer(geoLayer);
      if (id == 'region_select'){
        property = 'region';
      }
      if (id == 'depart_select'){
        property = 'departement_en_lettres';
      }
      return createGeolayer(map, data, value, id, property);
    }
    function get_user_select(map, geoLayer,id , data ){
      let user_selection = document.getElementById(id);
      user_selection.addEventListener('change', function(event){
        let element_selected = event.target.value;
        console.log("element_selected", element_selected);
        geoLayer = modify_layer(map, geoLayer, data, element_selected, id);
      });
    }
    window.onload = async () => {
        let map = L.map('map',{
          center: [48.665343,2.842226],
          zoom: 9
      });
        var layer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{
              maxZoom: 15,
              attribution: '© <a href="http://www.openstreetmap.org/copyright">OSM</a>'
        });
        layer.addTo(map);
        let response = await fetch("./monuments_historiques.geojson");
        let data = await response.json();
        let geoLayer = L.geoJSON(data);
        add_options_depart_region(data);
        get_user_select(map, geoLayer, 'region_select', data);
        get_user_select(map, geoLayer, 'depart_select', data);

    };
  </script>
 </body>
</html>
